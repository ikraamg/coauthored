<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coauthored</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 1rem; line-height: 1.5; }
    h1 { margin: 0; }
    .tagline { color: #666; margin: 0.5rem 0 1.5rem; }
    fieldset { border: 1px solid #ccc; margin-bottom: 1rem; padding: 1rem; }
    legend { font-weight: bold; padding: 0 0.5rem; }
    label { display: block; margin: 0.5rem 0; cursor: pointer; }
    label input { margin-right: 0.5rem; }
    select, input[type="text"], textarea { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #ccc; }
    textarea { min-height: 80px; resize: vertical; }
    .help { color: #666; font-size: 0.875rem; margin: 0.25rem 0 0.5rem; }
    .notice { background: #f5f5f5; border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; }
    .notice h3 { margin: 0 0 0.5rem; font-size: 1rem; }
    .notice p { margin: 0; font-size: 0.875rem; color: #666; }
    .assessment { padding: 1rem; color: white; text-align: center; margin: 1rem 0; font-weight: bold; }
    .output { background: #1e293b; color: #4ade80; padding: 1rem; font-family: monospace; word-break: break-all; margin: 1rem 0; }
    .actions { margin: 1rem 0; }
    button { padding: 0.75rem 1.5rem; cursor: pointer; margin-right: 0.5rem; border: 1px solid #ccc; background: white; }
    button.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
    .viewer-field { margin: 0.5rem 0; }
    .viewer-field strong { display: inline-block; min-width: 140px; }
    .badge-preview { margin: 1rem 0; }
    .badge-preview img { max-height: 20px; }
    footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; color: #666; font-size: 0.875rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Coauthored</h1>
    <p class="tagline" id="tagline"></p>
  </header>

  <main id="app">Loading...</main>

  <footer id="footer"></footer>

  <script type="module">
    import { loadConfig, assess, getFieldsByCategory, getLabel } from './config.js';
    import { encode, decode, parseUrl, buildUrl, badgeUrl, badgeMarkdown } from './core.js';

    let config = null;
    let formData = {};

    async function init() {
      try {
        config = await loadConfig();
        document.getElementById('title').textContent = config.ui?.title || 'Coauthored';
        document.getElementById('tagline').textContent = config.ui?.tagline || '';
        document.getElementById('footer').textContent = config.ui?.footer || '';
        route();
        window.addEventListener('hashchange', route);
      } catch (e) {
        document.getElementById('app').innerHTML = `<p style="color:red">Error loading config: ${e.message}</p>`;
      }
    }

    function route() {
      const hash = parseUrl(window.location.hash);
      if (hash) {
        const data = decode(hash);
        if (data) {
          renderViewer(data, hash);
          return;
        }
      }
      renderWizard();
    }

    function renderWizard() {
      const notice = config.ui?.notices?.wizard || {};
      const grouped = getFieldsByCategory(config);
      formData = { created: new Date().toISOString().split('T')[0] };

      let html = `
        <div class="notice">
          <h3>${notice.title || 'Good Faith Statement'}</h3>
          <p>${notice.text || ''}</p>
        </div>
        <form id="form">
      `;

      for (const [catKey, fields] of Object.entries(grouped)) {
        const cat = config.categories[catKey];
        html += `<fieldset><legend>${cat?.label || catKey}</legend>`;
        if (cat?.description) html += `<p class="help">${cat.description}</p>`;

        for (const field of fields) {
          if (field.auto) continue;
          html += renderField(field);
        }
        html += `</fieldset>`;
      }

      html += `
        </form>
        <div class="assessment" id="assessment" style="background:#6b7280">Documented</div>
        <div class="output" id="output"></div>
        <div class="badge-preview" id="badge"></div>
        <div class="actions">
          <button class="primary" onclick="copyOutput()">Copy Statement</button>
          <button onclick="copyMarkdown()">Copy Markdown</button>
        </div>
      `;

      document.getElementById('app').innerHTML = html;
      document.getElementById('form').addEventListener('input', updatePreview);
      document.getElementById('form').addEventListener('change', updatePreview);
      updatePreview();
    }

    function renderField(field) {
      const { key, type, label, description, values, placeholder, multiline } = field;

      if (type === 'enum') {
        return `
          <div>
            <label for="${key}">${label}</label>
            <p class="help">${description || ''}</p>
            <select name="${key}" id="${key}">
              <option value="">-- Select --</option>
              ${values.map(v => `<option value="${v.value}">${v.label} - ${v.desc}</option>`).join('')}
            </select>
          </div>
        `;
      }

      if (type === 'flags') {
        return `
          <div>
            <strong>${label}</strong>
            <p class="help">${description || ''}</p>
            ${values.map(v => `
              <label><input type="checkbox" name="${key}" value="${v.value}"> ${v.label} - ${v.desc}</label>
            `).join('')}
          </div>
        `;
      }

      if (type === 'text') {
        if (multiline) {
          return `
            <div>
              <label for="${key}">${label}</label>
              <p class="help">${description || ''}</p>
              <textarea name="${key}" id="${key}" placeholder="${placeholder || ''}"></textarea>
            </div>
          `;
        }
        return `
          <div>
            <label for="${key}">${label}</label>
            <p class="help">${description || ''}</p>
            <input type="text" name="${key}" id="${key}" placeholder="${placeholder || ''}">
          </div>
        `;
      }

      return '';
    }

    function collectFormData() {
      const form = document.getElementById('form');
      const data = { created: formData.created };

      for (const [key, field] of Object.entries(config.fields)) {
        if (field.auto) continue;

        if (field.type === 'flags') {
          const checked = [...form.querySelectorAll(`input[name="${key}"]:checked`)].map(el => el.value);
          if (checked.length) setNestedValue(data, key, checked);
        } else {
          const el = form.querySelector(`[name="${key}"]`);
          if (el?.value) setNestedValue(data, key, el.value);
        }
      }

      return data;
    }

    function setNestedValue(obj, path, value) {
      const parts = path.split('.');
      let current = obj;
      for (let i = 0; i < parts.length - 1; i++) {
        if (!(parts[i] in current)) current[parts[i]] = {};
        current = current[parts[i]];
      }
      current[parts[parts.length - 1]] = value;
    }

    function updatePreview() {
      const data = collectFormData();
      const result = assess(data, config);
      const encoded = encode(data, config);

      document.getElementById('assessment').style.background = `#${result.color}`;
      document.getElementById('assessment').textContent = result.label;
      document.getElementById('output').textContent = encoded;
      document.getElementById('badge').innerHTML = `<img src="${badgeUrl(result.label, result.color)}" alt="Badge">`;

      window._currentEncoded = encoded;
      window._currentResult = result;
    }

    function renderViewer(data, encoded) {
      const result = assess(data, config);
      const notice = config.ui?.notices?.viewer || {};

      let html = `
        <div class="notice">
          <h3>${notice.title || 'Good Faith Statement'}</h3>
          <p>${notice.text || ''}</p>
        </div>
        <div class="assessment" style="background:#${result.color}">${result.label}</div>
      `;

      for (const [key, field] of Object.entries(config.fields)) {
        const value = getNestedValue(data, key);
        if (!value) continue;

        let displayValue;
        if (Array.isArray(value)) {
          displayValue = value.map(v => getLabel(key, v, config)).join(', ');
        } else {
          displayValue = getLabel(key, value, config);
        }

        html += `<div class="viewer-field"><strong>${field.label}:</strong> ${displayValue}</div>`;
      }

      html += `
        <div class="output">${encoded}</div>
        <div class="badge-preview"><img src="${badgeUrl(result.label, result.color)}" alt="Badge"></div>
        <div class="actions">
          <button onclick="location.hash=''">Create New</button>
          <button onclick="copyText('${encoded}')">Copy Statement</button>
        </div>
      `;

      document.getElementById('app').innerHTML = html;
    }

    function getNestedValue(obj, path) {
      return path.split('.').reduce((o, k) => o?.[k], obj);
    }

    window.copyOutput = () => {
      navigator.clipboard.writeText(window._currentEncoded || '');
    };

    window.copyMarkdown = () => {
      const md = badgeMarkdown(window._currentEncoded, window._currentResult?.label || 'Documented', window._currentResult?.color || '6b7280', config.meta?.url);
      navigator.clipboard.writeText(md);
    };

    window.copyText = (text) => {
      navigator.clipboard.writeText(text);
    };

    init();
  </script>
</body>
</html>
