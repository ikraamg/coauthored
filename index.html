<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coauthored</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 1rem; line-height: 1.5; }
    h1 { margin: 0; }
    .tagline { color: #595959; margin: 0.5rem 0 1.5rem; }
    fieldset { border: 1px solid #ccc; margin-bottom: 1rem; padding: 1rem; }
    legend { font-weight: bold; padding: 0 0.5rem; }
    label { display: block; margin: 0.5rem 0; cursor: pointer; }
    label input { margin-right: 0.5rem; }
    label:has(input[type="checkbox"]) { margin: 0.75rem 0; padding: 0.5rem; border-radius: 4px; }
    label:has(input[type="checkbox"]):hover { background: #f9f9f9; }
    .option-desc { color: #595959; font-size: 0.8rem; margin-left: 1.5rem; display: block; margin-top: 0.15rem; }
    select, input[type="text"], textarea { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #767676; }
    select:focus, input:focus, textarea:focus, button:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }
    textarea { min-height: 80px; resize: vertical; }
    .help { color: #595959; font-size: 0.875rem; margin: 0.25rem 0 0.5rem; }
    .notice { background: #f5f5f5; border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; }
    .notice h2, .notice h3 { margin: 0 0 0.5rem; font-size: 1rem; }
    .notice p { margin: 0; font-size: 0.875rem; color: #595959; }
    .output { background: #1e293b; color: #4ade80; padding: 1rem; font-family: monospace; word-break: break-all; margin: 1rem 0; }
    .actions { margin: 1.5rem 0; display: flex; gap: 0.5rem; }
    button { padding: 0.75rem 1.5rem; cursor: pointer; margin-right: 0.5rem; border: 1px solid #ccc; background: white; }
    button.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
    .statement-details { margin-bottom: 1.5rem; }
    .statement-details table { width: 100%; border-collapse: collapse; }
    .statement-details th { text-align: left; padding: 0.5rem 1rem 0.5rem 0; color: #595959; font-weight: normal; white-space: nowrap; vertical-align: top; width: 140px; }
    .statement-details td { padding: 0.5rem 0; }
    .statement-details tr { border-bottom: 1px solid #eee; }
    hr { border: none; border-top: 1px solid #ddd; margin: 1.5rem 0; }
    .badge-section { margin: 1rem 0; }
    .badge-section img { max-height: 20px; margin-bottom: 0.5rem; }
    .copy-row { display: flex; gap: 0.5rem; margin: 0.5rem 0; }
    .copy-row input { flex: 1; font-family: monospace; font-size: 0.75rem; padding: 0.5rem; border: 1px solid #ccc; }
    .copy-row button { padding: 0.5rem 1rem; white-space: nowrap; }
    .section-label { font-size: 0.75rem; color: #595959; margin-top: 1rem; margin-bottom: 0.25rem; }
    footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; color: #595959; font-size: 0.875rem; }
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Coauthored</h1>
    <p class="tagline" id="tagline"></p>
  </header>

  <main id="app" aria-live="polite" aria-busy="true">Loading...</main>

  <footer id="footer"></footer>

  <script type="module">
    import { loadConfig, getFieldsByCategory, getLabel, getBadge, getNestedValue } from './config.js';
    import { encode, decode, parseUrl, buildUrl, badgeUrl, badgeMarkdown } from './core.js';

    let config = null;
    let formData = {};

    async function init() {
      try {
        config = await loadConfig();
        document.getElementById('title').textContent = config.ui?.title || 'Coauthored';
        document.getElementById('tagline').textContent = config.ui?.tagline || '';
        document.getElementById('footer').textContent = config.ui?.footer || '';
        route();
        window.addEventListener('hashchange', route);
      } catch (e) {
        document.getElementById('app').innerHTML = `<p style="color:red">Error loading config: ${e.message}</p>`;
      }
    }

    function route() {
      const hash = parseUrl(window.location.hash);
      if (hash) {
        const data = decode(hash);
        if (data) {
          renderViewer(data, hash);
          return;
        }
      }
      renderWizard();
    }

    function renderWizard() {
      const notice = config.ui?.notices?.wizard || {};
      const grouped = getFieldsByCategory(config);
      formData = { created: new Date().toISOString().split('T')[0] };

      document.getElementById('app').setAttribute('aria-busy', 'false');

      let html = `
        <div class="notice" role="note" aria-label="Important information">
          <h2>${notice.title || 'Good Faith Statement'}</h2>
          <p>${notice.text || ''}</p>
        </div>
        <form id="form" aria-label="AI collaboration statement form">
      `;

      for (const [catKey, fields] of Object.entries(grouped)) {
        const cat = config.categories[catKey];
        html += `<fieldset><legend>${cat?.label || catKey}</legend>`;
        if (cat?.description) html += `<p class="help">${cat.description}</p>`;

        for (const field of fields) {
          if (field.auto) continue;
          html += renderField(field);
        }
        html += `</fieldset>`;
      }

      html += `
        </form>

        <div class="actions">
          <button type="button" class="primary" onclick="viewStatement()">View Statement</button>
          <button type="button" onclick="resetForm()">Start Over</button>
        </div>

        <label for="output" class="section-label">Statement</label>
        <div class="copy-row">
          <input type="text" id="output" readonly aria-describedby="output-desc">
          <span id="output-desc" class="visually-hidden">Encoded statement string</span>
          <button type="button" onclick="copyField('output')">Copy</button>
        </div>

        <label for="url-output" class="section-label">URL (updates as you type)</label>
        <div class="copy-row">
          <input type="text" id="url-output" readonly aria-describedby="url-desc">
          <span id="url-desc" class="visually-hidden">Shareable URL for this statement</span>
          <button type="button" onclick="copyField('url-output')">Copy</button>
        </div>

        <label for="markdown-output" class="section-label">Badge Markdown</label>
        <div class="copy-row">
          <input type="text" id="markdown-output" readonly aria-describedby="markdown-desc">
          <span id="markdown-desc" class="visually-hidden">Markdown code for embedding badge</span>
          <button type="button" onclick="copyField('markdown-output')">Copy</button>
        </div>

        <div class="badge-section" id="badge" aria-label="Badge preview"></div>
      `;

      document.getElementById('app').innerHTML = html;
      document.getElementById('form').addEventListener('input', updatePreview);
      document.getElementById('form').addEventListener('change', updatePreview);
      updatePreview();
    }

    function renderField(field) {
      const { key, type, label, description, values, placeholder, multiline } = field;
      const helpId = `${key}-help`;
      const hasDesc = description && description.trim();

      if (type === 'enum') {
        return `
          <div>
            <label for="${key}">${label}</label>
            ${hasDesc ? `<p class="help" id="${helpId}">${description}</p>` : ''}
            <select name="${key}" id="${key}"${hasDesc ? ` aria-describedby="${helpId}"` : ''}>
              <option value="">-- Select --</option>
              ${values.map(v => `<option value="${v.value}" title="${v.desc || ''}">${v.label}</option>`).join('')}
            </select>
          </div>
        `;
      }

      if (type === 'flags') {
        const groupId = `${key}-group`;
        return `
          <div role="group" aria-labelledby="${groupId}">
            <strong id="${groupId}">${label}</strong>
            ${hasDesc ? `<p class="help" id="${helpId}">${description}</p>` : ''}
            ${values.map(v => `
              <label>
                <input type="checkbox" name="${key}" value="${v.value}"> ${v.label}
                ${v.desc ? `<span class="option-desc">${v.desc}</span>` : ''}
              </label>
            `).join('')}
          </div>
        `;
      }

      if (type === 'text') {
        if (multiline) {
          return `
            <div>
              <label for="${key}">${label}</label>
              ${hasDesc ? `<p class="help" id="${helpId}">${description}</p>` : ''}
              <textarea name="${key}" id="${key}" placeholder="${placeholder || ''}"${hasDesc ? ` aria-describedby="${helpId}"` : ''}></textarea>
            </div>
          `;
        }
        return `
          <div>
            <label for="${key}">${label}</label>
            ${hasDesc ? `<p class="help" id="${helpId}">${description}</p>` : ''}
            <input type="text" name="${key}" id="${key}" placeholder="${placeholder || ''}"${hasDesc ? ` aria-describedby="${helpId}"` : ''}>
          </div>
        `;
      }

      return '';
    }

    function collectFormData() {
      const form = document.getElementById('form');
      const data = { created: formData.created };

      for (const [key, field] of Object.entries(config.fields)) {
        if (field.auto) continue;

        if (field.type === 'flags') {
          const checked = [...form.querySelectorAll(`input[name="${key}"]:checked`)].map(el => el.value);
          if (checked.length) setNestedValue(data, key, checked);
        } else {
          const el = form.querySelector(`[name="${key}"]`);
          if (el?.value) setNestedValue(data, key, el.value);
        }
      }

      return data;
    }

    function setNestedValue(obj, path, value) {
      const parts = path.split('.');
      let current = obj;
      for (let i = 0; i < parts.length - 1; i++) {
        if (!(parts[i] in current)) current[parts[i]] = {};
        current = current[parts[i]];
      }
      current[parts[parts.length - 1]] = value;
    }

    function getBaseUrl() {
      return window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');
    }

    function updatePreview() {
      const data = collectFormData();
      const badge = getBadge(config);
      const encoded = encode(data, config);
      const baseUrl = getBaseUrl();

      document.getElementById('output').value = encoded;
      document.getElementById('url-output').value = `${baseUrl}/#${encoded}`;
      document.getElementById('markdown-output').value = badgeMarkdown(encoded, badge.text, badge.color, baseUrl);
      document.getElementById('badge').innerHTML = `<img src="${badgeUrl(badge.text, badge.color)}" alt="Badge Preview">`;

      window._currentEncoded = encoded;
    }

    function renderViewer(data, encoded) {
      const badge = getBadge(config);
      const notice = config.ui?.notices?.viewer || {};
      const baseUrl = getBaseUrl();
      const fullUrl = `${baseUrl}/#${encoded}`;
      const markdown = badgeMarkdown(encoded, badge.text, badge.color, baseUrl);

      document.getElementById('app').setAttribute('aria-busy', 'false');

      let html = `
        <div class="notice" role="note">
          <h2>${notice.title || 'Good Faith Statement'}</h2>
          <p>${notice.text || ''}</p>
        </div>
        <section class="statement-details" aria-label="Statement details">
          <table>
      `;

      for (const [key, field] of Object.entries(config.fields)) {
        const value = getNestedValue(data, key);
        if (!value) continue;

        let displayValue;
        if (Array.isArray(value)) {
          displayValue = value.map(v => getLabel(key, v, config)).join(', ');
        } else {
          displayValue = getLabel(key, value, config);
        }

        html += `<tr><th scope="row">${field.label}</th><td>${displayValue}</td></tr>`;
      }

      html += `
          </table>
        </section>

        <hr>

        <section class="copy-section" aria-label="Copy options">
          <label for="viewer-statement" class="section-label">Statement</label>
          <div class="copy-row">
            <input type="text" id="viewer-statement" value="${encoded}" readonly>
            <button type="button" onclick="copyField('viewer-statement')">Copy</button>
          </div>

          <label for="viewer-url" class="section-label">URL</label>
          <div class="copy-row">
            <input type="text" id="viewer-url" value="${fullUrl}" readonly>
            <button type="button" onclick="copyField('viewer-url')">Copy</button>
          </div>

          <label for="viewer-markdown" class="section-label">Badge Markdown</label>
          <div class="copy-row">
            <input type="text" id="viewer-markdown" value="${escapeAttr(markdown)}" readonly>
            <button type="button" onclick="copyField('viewer-markdown')">Copy</button>
          </div>

          <div class="badge-section"><img src="${badgeUrl(badge.text, badge.color)}" alt="AI Coauthored badge"></div>
        </section>

        <div class="actions">
          <button type="button" class="primary" onclick="location.hash=''">Create New Statement</button>
        </div>
      `;

      document.getElementById('app').innerHTML = html;
    }

    function escapeAttr(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    window.copyField = (id) => {
      const el = document.getElementById(id);
      if (el) navigator.clipboard.writeText(el.value);
    };

    window.resetForm = () => {
      history.pushState(null, '', window.location.pathname);
      route();
    };

    window.viewStatement = () => {
      if (window._currentEncoded) {
        history.pushState(null, '', `#${window._currentEncoded}`);
        route();
      }
    };

    init();
  </script>
</body>
</html>
